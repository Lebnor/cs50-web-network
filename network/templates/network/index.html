{% extends "network/layout.html" %}

{% load static %}



{% block body %}

<!-- starting point of react app -->
<div class="body" id="root">

</div>


<script type="text/babel">

    var context = {
        user: `{{ user }}`
    }

    class NewPost extends React.Component {
        constructor(props) {
            super(props);
            this.state = ({
                textAreaValue: 'Type your post here...',
                firstClick: true
            })
        }
        handleKeyDown() {
            if (this.state.firstClick) {
                this.setState({
                    textAreaValue: '',
                    firstClick: false
                })
            }
            if (this.state.textAreaValue === '') {
                document.getElementById('submit').disabled = true;
            } else {
                document.getElementById('submit').disabled = false;
            }
        }
        handleOnChange(event) {
            this.setState({
                textAreaValue: event.target.value
            })
        }



        handleOnSubmit() {
            console.log('onsubmit')
            console.log(this.state.textAreaValue)
            // TODO add some checks
            fetch("posts/create/" + this.state.textAreaValue)
                .then(response => response.json())
                .then( data =>
                    this.setState({
                        textAreaValue: ''
                    })
                )
                .catch();




        }
        render() {
            var notLoggedIn = <p className="text-danger">Please 
                 <a href="{% url 'login' %}"> Log in </a>
                 or 
                 <a href="{% url 'register' %}"> Register </a>
                  to make a new post.</p>
            var loggedIn = <div className="col-8">
                            <form>
                                <textarea required
                                    onKeyDown={() => this.handleKeyDown()}
                                    onChange={(event) => this.handleOnChange(event)}
                                    className="form-control" value={this.state.textAreaValue}>
                                </textarea>

                                <div className="text-center m-2">
                                    <input id="submit"
                                        onClick={() => this.handleOnSubmit()}
                                        className="btn btn-outline-info" type="submit" value="Submit">
                                    </input>
                                </div>
                            </form>
                        </div>;

                let content;
                if (context.user === 'AnonymousUser') { // not logged in
                    content = notLoggedIn;
                } else {
                    content = loggedIn;
                }
            return (
                <div className="col-8 border text-center  m-3">

                    <h3 className="text-white m-3"><span className="rounded p-2">New Post</span> </h3>
                    <div className="row  justify-content-center pb-2">
                        {content}
                    </div>
                </div>
            )
        }
    }
    class Load extends React.Component {
        render() {
            return (
                <div className="row justify-content-center">
                    <p className="loader mx-2"> </p>
                    {this.props.message}
                </div>
            )
        }
    }


    class Expire extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                visible: true
            }
        }

        componentWillReceiveProps(nextProps) {
            // reset the timer if children are changed
            if (nextProps.children !== this.props.children) {
                this.setTimer();
                this.setState({ visible: true });
            }
        }

        componentDidMount() {
            this.setTimer();
        }

        setTimer() {
            // clear any existing timer
            if (this._timer != null) {
                clearTimeout(this._timer)
            }

            // hide after `delay` milliseconds
            this._timer = setTimeout(function () {
                this.setState({ visible: false });
                this._timer = null;
            }.bind(this), this.props.delay);
        }

        componentWillUnmount() {
            clearTimeout(this._timer);
        }

        render() {
            return this.state.visible
                ? <div>{this.props.children}</div>
                : <span />;
        }
    }

    class Post extends React.Component {
        constructor(props) {
            super(props)
        }

        render() {
            let post = this.props.post;

            return (
                <div key={post.id} className="mx-2 mb-2 p-4 border border-info">
                    <p> <strong>Author: </strong> {post.poster}</p>
                    <p> <strong>Body: </strong> {post.text}</p>
                    <p> <strong>Likes: </strong> {post.likes}</p>
                    <p> <strong>Date: </strong> {post.timestamp} </p>
                </div>
            )
        }
    }
    class Posts extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                posts: false
            }
        }


        showPosts() {

            fetch("/posts")
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    this.setState({
                        posts: data,
                        loadingPosts:

                            <Expire delay="2000">
                                <p className="secondary-color-text">Loaded posts successfully</p>
                            </Expire>
                    });

                })
                .catch((e) => {
                    console.log(e);
                    this.setState({
                        loadingPosts: <Expire>
                            <p className="text-danger"> Failed to load posts</p>
                        </Expire>
                    })
                });

        }

        render() {


            let loadingIcon = <Load message={'loading...'}> </Load>
            if (this.props.loading === false) {
                loadingIcon = <span> </span>
            }

            // read posts from props or update it from state
            let posts;
            if (this.state.posts) {
                posts = this.state.posts.map(post => <Post key={post.id} post={post}> </Post>);
            } else {
                posts = this.props.posts.map(post => <Post key={post.id} post={post}> </Post>)
            }
            return (
                <div className="container">
                    <div className="">
                        <div className="row justify-content-center">
                            <NewPost> </NewPost>
                        </div>
                        <div className="row justify-content-center">
                            <h3 className="my-2"> <span className="p-2 rounded">Showing all posts</span> </h3>
                        </div>
                        <div className="row justify-content-center my-1">
                            <div className="col-9 col-md-7">
                                <div className="row justify-content-end">
                                    <button className="text-white btn m-0" onClick={() => {
                                        this.showPosts()
                                        this.setState({
                                            loadingPosts: <Load message={'Loading posts...'}> </Load>
                                        })

                                    }
                                    }>Reload posts </button>
                                </div>
                                <div className="row justify-content-center">
                                    {this.state.loadingPosts}
                                    {loadingIcon}
                                </div>
                            </div>
                        </div>

                        <div className="row justify-content-center">
                            <div className="col-10 col-md-8">

                                {posts}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }


    }

    fetch("/posts")
        .then(response => response.json())
        .then(data => {
            ReactDOM.render(<Posts posts={data} loading={false} />, document.getElementById('root'));
        });
    ReactDOM.render(<Posts posts={[]} />, document.getElementById('root'));
</script>
{% endblock %}