{% extends "network/layout.html" %}




{% block body %}

<!-- starting point of react app -->
<div class="body" id="root">

</div>


 <script type="text/babel">

    var context = {
        user: `{{ user }}`
    }
    
class NewPost extends React.Component {
    constructor(props) {
        super(props);
        this.state = ( {
            textAreaValue: 'Type your post here...',
            firstClick: true
        })
    }
    handleKeyDown() {
        if (this.state.firstClick) {
            this.setState( {
                textAreaValue: '',
                firstClick: false
            })
        }
    }
    handleOnChange(event) {
            this.setState( {
            textAreaValue: event.target.value
        })
        
    }

    handleOnSubmit() {
        // TODO add some checks
        fetch("/posts/create/" + this.state.textAreaValue).
        then()
        .then()
        .catch();

        this.setState( {
            textAreaValue: ''
        })
    }
    render() {
        
        return (
            <div className="col-8 border text-center  m-3">

                <h3 className="text-white m-3"><span className="rounded p-2">New Post</span> </h3>
            <div className="row  justify-content-center p-2">    
                <div className="col-8 p-2">
                    <form>
                    <textarea onKeyDown={ () => this.handleKeyDown()} onChange={ (event) => this.handleOnChange(event)} className="form-control" value={this.state.textAreaValue}></textarea>
                    
                    <div className="text-center m-2">
                        <input onClick={ () => this.handleOnSubmit()} className="btn btn-outline-primary" type="submit" value="Submit"></input>
                    </div>
                        </form>
                    </div>
                </div>
            </div>
        )
    }
}
class Load extends React.Component {
        render() {
            return (
                <div className="row justify-content-center">
                <p className="loader mx-2"> </p> 
                     {this.props.message}
                 </div>
            )
        }
    }


class Expire extends React.Component {
  constructor(props) {
    super(props);
    this.state = {visible:true}
  }

  componentWillReceiveProps(nextProps) {
    // reset the timer if children are changed
    if (nextProps.children !== this.props.children) {
      this.setTimer();
      this.setState({visible: true});
    }
  }

  componentDidMount() {
    this.setTimer();
  }

  setTimer() {
    // clear any existing timer
    if (this._timer != null) {
      clearTimeout(this._timer)
    }

    // hide after `delay` milliseconds
    this._timer = setTimeout(function(){
      this.setState({visible: false});
      this._timer = null;
    }.bind(this), this.props.delay);
  }

  componentWillUnmount() {
    clearTimeout(this._timer);
  }

  render() {
    return this.state.visible
      ? <div>{this.props.children}</div>
      : <span />;
  }
}
    
class Post extends React.Component {
        constructor(props) {
            super(props)
        }

        render() {
            let post = this.props.post;

            return (
            <div key={post.id} className="m-2 p-4 border border-info">
                <p> <strong>Author: </strong> {post.poster}</p>
                <p> <strong>Body: </strong> {post.text}</p>
                <p> <strong>Likes: </strong> {post.likes}</p>
                <p> <strong>Date: </strong> {post.timestamp} </p>                                    
            </div>
            )
        }
    }
    class Posts extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                posts: false
            }
        }


        showPosts() {
            
            fetch("/posts")
                    .then(response => response.json())
                    .then( ( data ) => {
                        console.log(data);
                        this.setState( {
                            posts: data,
                            loadingPosts: 
                            
                                <Expire delay="5000">
                                    <p className="text-success">Loaded posts successfully</p>
                                </Expire>
                            });

                    })
                    .catch( (e)=>{
                        console.log(e);
                        this.setState({
                            loadingPosts: <Expire>
                                            <p className="text-danger"> Failed to load posts</p>
                                          </Expire>
                                        })
                    });

        }

        render() {
           
            
            let loadingIcon = <Load message={'loading...'}> </Load>
            if (this.props.loading === false) {
                loadingIcon = <span> </span>
            }

            // read posts from props or update it from state
            let posts;
            if (this.state.posts) {
                posts = this.state.posts.map(post => <Post key={post.id} post={post}> </Post>);
            } else {
                posts = this.props.posts.map(post => <Post key={post.id} post={post}> </Post>)
            }
            return (
                <div className="container">
                    <div className="">
                        <div className="row justify-content-center">
                            <NewPost> </NewPost>
                        </div>
                        <div className="row justify-content-center">
                            <h3 className="my-2"> <span className="p-2 rounded">Showing all posts</span> </h3>
                        </div>
                        <div className="row justify-content-center">
                            <button className="btn btn-primary m-2" onClick={()=> {
                                this.showPosts()
                                this.setState({
                                    loadingPosts: <Load message={'Loading posts...'}> </Load>
                                })

                            }
                            }>Reload posts </button>
                        </div>
                        <div className="row  justify-content-center">
                            <div className="">
                                {this.state.loadingPosts}
                            </div>
                        </div>
                        <div className="row justify-content-center">
                            <div className="col-10 col-md-8">
                                {loadingIcon}
                                {posts}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        
    }
    
    fetch("/posts")
            .then(response => response.json())
            .then(data => {
                ReactDOM.render(<Posts posts={data} loading={false}/>, document.getElementById('root'));
            });
    ReactDOM.render(<Posts posts={[]}/>, document.getElementById('root'));
</script>
{% endblock %}