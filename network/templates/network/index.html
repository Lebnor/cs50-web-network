{% extends "network/layout.html" %}

{% load static %}



{% block body %}

<!-- starting point of react app -->
<div class="body" id="root">

</div>


<script type="text/babel">


    var context = {
        user: `{{ user }}`,
    }

    fetch("/users/current")
        .then(response => response.json())
        .then(result => {
            context.user = result
        })
    window.onpopstate = function (event) {
        if (event.state.user) {
            profileView(event.state.user);
        } else if (event.state.view === 'main') {
            mainView();
        } else if (event.state.view === 'follow') {
            followView();
        }
    }

    function followView() {

        fetch("/posts/following")
            .then(response => response.json())
            .then(data => {
                console.log(data);
                ReactDOM.render(<FollowingView data={data} />, document.getElementById('root'));
            })
    }

    function profileView(username) {
        console.log(username);
        fetch(`/users/get/${username}`)
            .then(response => response.json())
            .then(data => {
                ReactDOM.render(<Profile key={username} postsForUser={data.postsForUser} profile={data.profile} filter={username} refresh={true} />, document.getElementById('root'));
            })
            .catch(e => console.log(e))
    }

    // main view for this web page
    function mainView() {
        fetch("/posts")
            .then(response => response.json())
            .then(data => {
                ReactDOM.render(<Posts posts={data} loading={false} />, document.getElementById('root'));
            })
            .catch(e => console.log(e));
    }
    
    class FollowingView extends React.Component {
        constructor(props) {
            super(props)
            this.state = {

            }
        }

        render() {
            return (
                <div className="row justify-content-center py-4">
                    <div className="col-12 col-sm-8">
                        <div className="text-center">
                            <Header headline={'Posts from users you follow'} />
                        </div>
                        <Paginator data={this.props.data} filter={`posts/following`} />
                    </div>
                </div>
            )
        }
    }
    // ui to go back and forth between pages that display posts
    class Paginator extends React.Component {
        constructor(props) {
            super(props)

            this.state = {
                currentPage: 0
            }

            this.reload();
        }

        updatePageCounter(increment) {

            this.setState({
                currentPage: this.state.currentPage + increment
            })
        }

        nextClassName(pageIndex, max) {
            return pageIndex >= max - 1 ? "page-item disabled" : "page-item";
        }
        prevClassName(pageIndex, max) {
            return pageIndex <= 0 ? "page-item disabled" : "page-item";
        }

        reload() {

            let searchTerm = this.props.filter ? this.props.filter : '';
            console.log(`/${searchTerm}`)
            fetch(`/${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    this.setState({
                        data: data,
                        loading: false
                    })
                })
                .catch(() => {
                    this.setState({
                        loading: false
                    })
                })

        }
        render() {

            // empty props, nothing to show
            if (this.props.data.length === 0 && this.state.data && this.state.data.length === 0) {
                return (
                    <div></div>
                )
            }

            let data = this.state.data ? this.state.data : this.props.data;


            let pagesCounter = 0;
            let pages = [];
            let page = [];
            for (let i = 0; i < data.length; i++) {
                if ((i % 9 === 0 && i !== 0) || i === data.length - 1) {
                    page.push(data[i]);
                    pages[pagesCounter] = page;
                    pagesCounter++;
                    page = [];
                } else {
                    page.push(data[i]);
                }
            }

            let pageIndex = this.state.currentPage ? this.state.currentPage : 0;
            page = pages[pageIndex];

            if (!page)
                return <span> </span>

            const previousButton = <li className={this.prevClassName(pageIndex, pages.length)}><a className="page-link" href=""
                onClick={(e) => {
                    e.preventDefault();
                    this.updatePageCounter(-1)
                }}
            >Previous</a>
            </li>;

            const nextButton = <li className={this.nextClassName(pageIndex, pages.length)}><a className="page-link" href=""
                onClick={(e) => {
                    e.preventDefault();
                    this.updatePageCounter(1)
                }}
            >Next</a>
            </li>;

            return (

                <div className="">
                    <div className="row justify-content-between px-4">
                        <h3 > Page {pageIndex + 1} </h3>
                        <nav className="align-self-center" aria-label="Page navigation">
                            <ul className="pagination">
                                {previousButton}
                                {pages.map((page, index) => {
                                    return (
                                        <li key={index} className="page-item">
                                            <a className="page-link" href=""
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    this.setState({
                                                        currentPage: index
                                                    })
                                                }}> {index + 1} </a>
                                        </li>
                                    )
                                })}
                                {nextButton}
                            </ul>
                        </nav>
                        <button className="align-self-start btn btn-primary"
                            onClick={() => {
                                this.reload()
                                this.setState({
                                    loading: <Load message={'Reloading content...'}> </Load>
                                })
                            }
                            }
                        > Reload </button>
                    </div>
                    {this.state.loading}

                    {page.map((post, index) => {
                        return (
                            <div key={post.id}>
                                <Post post={post}> </Post>
                            </div>
                        )
                    })}
                    <div className="row justify-content-center">
                        <nav aria-label="Page navigation">
                            <ul className="pagination">
                                {previousButton}
                                {pages.map((page, index) => {
                                    return (
                                        <li key={index} className="page-item">
                                            <a className="page-link" href=""
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    this.setState({
                                                        currentPage: index
                                                    })
                                                }}> {index + 1} </a>
                                        </li>
                                    )
                                })}
                                {nextButton}
                            </ul>
                        </nav>
                    </div>
                </div>

            )
        }
    }
    class NewPost extends React.Component {
        constructor(props) {
            super(props);
            this.state = ({
                textAreaValue: 'Type your post here...',
                firstClick: true
            })
        }
        handleKeyDown() {
            if (this.state.firstClick) {
                this.setState({
                    textAreaValue: '',
                    firstClick: false
                })
            }
            if (this.state.textAreaValue === '') {
                document.getElementById('submit').disabled = true;
            } else {
                document.getElementById('submit').disabled = false;
            }
        }
        handleOnChange(event) {
            this.setState({
                textAreaValue: event.target.value
            })
        }



        handleOnSubmit() {
            fetch("posts/create/" + this.state.textAreaValue)
                .then(response => response.json())
                .then(data =>
                    this.setState({
                        textAreaValue: ''
                    })
                )
                .catch();

        }
        render() {
            var notLoggedIn = <p className="text-danger">Please
                 <a href="{% url 'login' %}"> Log in </a>
                 or
                 <a href="{% url 'register' %}"> Register </a>
                  to make a new post.</p>
            var loggedIn = <div className="col-12 col-md-8">
                <form>
                    <textarea required
                        onKeyDown={() => this.handleKeyDown()}
                        onChange={(event) => this.handleOnChange(event)}
                        className="form-control" value={this.state.textAreaValue}>
                    </textarea>

                    <div className="text-center m-2">
                        <input id="submit"
                            onClick={() => this.handleOnSubmit()}
                            className="btn btn-outline-primary" type="submit" value="Submit">
                        </input>
                    </div>
                </form>
            </div>;

            let content;
            if (context.user === 'AnonymousUser') { // not logged in
                content = notLoggedIn;
            } else {
                content = loggedIn;
            }
            return (
                <div className="col-12 col-md-8 border border-info text-center  m-3">
                    <h3 className="text-white mb-3 mx-3"><span className="rounded p-2 px-3">New Post</span> </h3>
                    <div className="row  justify-content-center pb-2">
                        {content}
                    </div>
                </div>
            )
        }
    }


    class Load extends React.Component {
        render() {
            return (
                <div className="row justify-content-center mb-2">
                    <p className="loader mx-2"> </p>
                    {this.props.message}
                </div>
            )
        }
    }

    class Expire extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                visible: true
            }
        }

        componentWillReceiveProps(nextProps) {
            // reset the timer if children are changed
            if (nextProps.children !== this.props.children) {
                this.setTimer();
                this.setState({ visible: true });
            }
        }

        componentDidMount() {
            this.setTimer();
        }

        setTimer() {
            // clear any existing timer
            if (this._timer != null) {
                clearTimeout(this._timer)
            }

            // hide after `delay` milliseconds
            this._timer = setTimeout(function () {
                this.setState({ visible: false });
                this._timer = null;
            }.bind(this), this.props.delay);
        }

        componentWillUnmount() {
            clearTimeout(this._timer);
        }

        render() {
            return this.state.visible
                ? <div>{this.props.children}</div>
                : <span />;
        }
    }


    // TODO serve Profile from another file
    class Profile extends React.Component {
        constructor(props) {
            super(props)
            this.state = {
                profile: this.props.profile,
                loading: false,
            }

        }


        isInFollowing() {
            console.log(context.user)
            let profile = this.state.profile;
            for (let i = 0; i < profile.followers.length; i++) {
                console.log(profile.followers[i])

                if (profile.followers[i].username === context.user) {
                    return true;
                }
            }

            return false;
        }

        handleFollow(username) {
            this.setState({
                loading: <Load ></Load>
            })
            console.log(`handleFollow: ${username}`)
            fetch(`/users/follow/${username}`)
                .then(response => response.json())
                .then(result => {
                    this.setState({
                        profile: result.profile,
                        loading: false
                    })
                })
        }

        handleUnfollow(username) {
            this.setState({
                loading: <Load> </Load>
            })
            console.log(`handleUnfollow:${username}`)
            fetch(`/users/unfollow/${username}`)
                .then(response => response.json())
                .then(result => {
                    this.setState({
                        profile: result.profile,
                        loading: false
                    })
                })
                .catch(e => {
                    console.log(e)
                    this.setState({
                        loading: false
                    })
                })


        }

        render() {

            let isInFollowing = this.isInFollowing();
            let isOwnProfile = this.props.profile.user.username === context.user.username;
            let followButton;

            if (!isOwnProfile) {
                if (isInFollowing) {
                    // create button to unfollow
                    followButton = <div className="my-2">
                        <span className="lead m-1"> Click to unfollow {this.props.profile.user.username}: </span>
                        <button onClick={() => this.handleUnfollow(this.props.profile.user.username)} className="btn btn-outline-danger">{this.state.loading ? this.state.loading : 'Unfollow'} </button>
                    </div>
                } else {
                    // create button to follow
                    followButton = <div className="my-2">
                        <span className="lead m-1"> Click to follow {this.props.profile.user.username}: </span>
                        <button onClick={() => this.handleFollow(this.props.profile.user.username)} className="btn btn-outline-success">{this.state.loading ? this.state.loading : 'Follow'} </button>
                    </div>
                }

            }

            let postsForUser = <span> </span>
            postsForUser =
                <div>
                    {this.props.postsForUser.map(post => {
                        return (
                            <div key={post.id}>
                                <Post post={post}> </Post>
                            </div>
                        )
                    })
                    }
                </div>
            return (

                <div>
                    <div className="py-4 container-fluid top-node">
                        <div className="py-3 text-center">
                            <h3> <span className="p-2 px-3 rounded">{this.props.profile.user.username}'s profile</span></h3>
                        </div>
                    </div>

                    <div className="row justify-content-center">
                        <div className="col-auto">
                            {followButton}
                        </div>
                    </div>

                    <div className="row justify-content-center">
                        <div className="my-4 col-12 col-md-6">
                            <h5> Following: <span className="lead"> {this.props.profile.following.length} users </span></h5>
                            <ul> {this.props.profile.following.map(follower => {
                                return (
                                    <li className="px-2" key={follower.id}>
                                        <a href="" onClick={(e) => {
                                            e.preventDefault();
                                            history.pushState({ user: follower.username }, "", follower.username);
                                            this.setState({
                                                refreshData: true
                                            })
                                            profileView(follower.username)
                                        }}>
                                            {follower.username}
                                        </a>
                                    </li>
                                )
                            })}
                            </ul>
                            <hr />
                            <h5> Followers: <span className="lead"> {this.props.profile.followers.length} users </span></h5>
                            <ul>
                                {this.props.profile.followers.map(follower => {
                                    return (
                                        <li className="col" key={follower.id}>
                                            <a href="" onClick={(e) => {
                                                e.preventDefault();
                                                history.pushState({ user: follower.username }, "", follower.username);
                                                profileView(follower.username);
                                            }}
                                            >{follower.username}</a>
                                        </li>
                                    )
                                })}
                            </ul>
                        </div>

                    </div>

                    <div className="row justify-content-center">
                        <div className="col-12 col-sm-8">
                            <Paginator key={this.props.profile.user.username} data={this.props.postsForUser} filter={`posts/${this.props.profile.user.username}`}> </Paginator>
                        </div>
                    </div>
                </div>
            )
        }


    }

    // receives as props a json object representing a post
    class Post extends React.Component {
        constructor(props) {
            super(props)
            this.state = {
                editMode: false,
                text: this.props.post.text,
                value: this.props.post.text,
                loading: false,
                liked: false,
                likesCount: this.props.post.likes
            }
        }

        handleOnClick(username) {
            profileView(username);
        }

        handleEditButton() {
            this.setState({
                editMode: true
            })
        }


        closeEditMode() {
            document.getElementById(`edit${this.props.post.id}`).style.animationPlayState = 'running';
            document.getElementById(`edit${this.props.post.id}`).onanimationend = () => {
                this.setState({
                    editMode: false,
                    loading: false
                })

            }
        }
        handleCancel() {
            this.closeEditMode();
        }

        handleSave() {
            this.setState({
                loading: <Load />
            })
            let id = this.props.post.id
            let content = this.state.value;
            fetch(`posts/edit/${id}/${content}`)
                .then(response => response.json())
                .then(result => {
                    this.setState({
                        text: result.post.text
                    })
                    this.closeEditMode();
                })
        }
        handleOnChange(event) {
            this.setState({
                value: event.target.value
            })
        }

        handleLike(event) {
            this.setState({
                liked: true,
                likesCount: this.state.likesCount + 1
            })
            event.target.style.animationPlayState = 'running';
            console.log('handleLike()');
            let id = this.props.post.id;
            console.log(id)
            context.user.likes.push(id);

            // TODO update post in database
            fetch(`/posts/like/${id}`)
        }
        handleDislike(event) {
            this.setState({
                liked: false,
                likesCount: this.state.likesCount - 1
            })
            event.preventDefault();
            let id = this.props.post.id;
            console.log(id);
            const index = context.user.likes.indexOf(id);
            if (index > -1) {
                context.user.likes.splice(index, 1);
            }

            // TODO update post in database
            fetch(`/posts/dislike/${id}`)
        }
        getLikeIcon(isLiked) {
            if (isLiked) {
                return (
                    <i href="" className="jump bi bi-heart-fill text-danger"
                        onClick={(e) => this.handleDislike(e)}>
                    </i>
                )
            } else {
                return (
                    <i href="" className="bi bi-heart text-danger"
                        onClick={(e) => this.handleLike(e)}>
                    </i>
                )
            }
        }

        // TODO implement this more efficiently
        isLiked() {
            for (let i = 0; i < context.user.likes.length; i++) {
                if (context.user.likes[i] == this.props.post.id)
                    return true;
            }
            return false;
        }
        render() {
            let post = this.props.post;

            let isOwnPost = this.props.post.poster.username == context.user.username;
            let editButton = null;
            if (isOwnPost) {
                editButton =
                    <button className="btn btn-link" onClick={() => this.handleEditButton()}>

                        <i className="bi bi-pencil-square"></i> Edit

                    </button>
            }


            let postBody = null;
            if (this.state.editMode) {

                postBody =
                    <div id={`edit${post.id}`} className="appear disappear shadow-sm w-100">

                        <h5 className="text-warning mx-4 p-2 text-center"> Edit mode </h5>
                        <div>
                            <div className="row justify-content-center">
                                <div className="col mx-1">
                                    <textarea className="form-control" onChange={(e) => this.handleOnChange(e)} defaultValue={post.text} />
                                </div>

                            </div>
                            <div className="row justify-content-end">
                                <div className="col-auto">
                                    <button onClick={() => this.handleSave()} className="btn btn-outline-success"> {this.state.loading || (<span className="bi bi-check-circle"> save</span>)} </button>
                                    <button onClick={() => this.handleCancel()} className="m-2 btn btn-danger"><i className="bi bi-x-circle"></i> cancel </button>
                                </div>
                            </div>
                        </div>

                    </div>
            } else {
                postBody = <p> <strong>Body: </strong> {this.state.text}</p>

            }


            // determine if the user liked this post            
            let likeIcon = this.getLikeIcon(this.isLiked());

            return (
                <div key={post.id} className="shadow post mx-2 mb-2 p-4 border border-info">
                    <div className="text-center">
                        {editButton}
                    </div>
                    <p> <strong>Author: </strong> <a href="" onClick={(e) => {
                        e.preventDefault();
                        history.pushState({ user: post.poster.username }, "", `users/${post.poster.username}`);
                        this.handleOnClick(post.poster.username);
                    }}>{post.poster.username} </a>
                    </p>
                    {postBody}
                    <p>{likeIcon} {this.state.likesCount} </p>
                    <p> <strong>Date: </strong> {post.timestamp} </p>

                </div>
            )
        }
    }

    class LikeButton extends React.Component {
        constructor(props) {
            super(props)

            this.icon = React.createRef();
        }

        handleOnClick(e) {
            console.log(' clicked');
            e.target.style.animationPlayState = 'running';

            this.props.doClick();
        }
        render() {
            return (
                <i onClick={(e) => this.handleOnClick(e)} ref={this.icon} className="jump bi bi-heart text-danger"> </i>
            )
        }
    }
    class Header extends React.Component {
        render() {
            return (
                <h3 className="text-white mb-3 mx-3"><span className="shadow-sm rounded p-2 px-3"> {this.props.headline} </span> </h3>
            )
        }


    }
    class Posts extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                posts: false
            }
        }


        showPosts() {

            fetch("/posts")
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    this.setState({
                        posts: data,
                        loadingPosts:

                            <Expire delay="1000">
                                <p className="secondary-color-text">Loaded posts successfully</p>
                            </Expire>
                    });

                })
                .catch((e) => {
                    console.log(e);
                    this.setState({
                        loadingPosts: <Expire>
                            <p className="text-danger"> Failed to load posts</p>
                        </Expire>
                    })
                });

        }

        render() {

            // read posts from props or update it from state
            let posts = this.state.posts ? this.state.posts : this.props.posts;

            let loadingIcon = <Load message={'loading...'}> </Load>
            if (this.props.loading === false) {
                loadingIcon = <span> </span>
            }

            let postsList = posts.map(post => <Post key={post.id} post={post}> </Post>)
            return (

                <div>
                    <div className="container-fluid">
                        <div className="top-node pb-4 pt-4 mb-4 row justify-content-center">
                            <NewPost> </NewPost>
                        </div>
                    </div>
                    <div className="container">
                        <div className="">

                            <div className="row justify-content-center">
                                <Header headline={'Showing all posts'} />
                            </div>
                            <div className="row justify-content-center my-1">
                                <div className="col-9 col-md-7">
                                    <div className="row justify-content-center">

                                        {loadingIcon}
                                        {this.state.loadingPosts}
                                    </div>

                                </div>
                            </div>

                            <div className="row justify-content-center">
                                <div className="col-10 col-md-8">
                                    <Paginator data={posts} filter={''}> </Paginator>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }


    }

    // decide which view to show
    if (window.location.pathname === "" || window.location.pathname === "/") {
        // load main view
        history.pushState({ view: 'main' }, "", "/");
        mainView();
        ReactDOM.render(<Posts posts={[]} />, document.getElementById('root'));
    } else if (window.location.pathname === "/follow") {
        history.pushState({ view: 'follow' }, "", "follow");
        followView();
    } else {
        // load profile
        let username = window.location.pathname.substr(7);
        console.log(username);
        history.pushState({ username: username }, "", `${username}`);
        profileView(username);
    }
</script>

{% endblock %}